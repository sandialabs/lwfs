
To get this to compile, install 
	krb5, krb5-devel, krb5-client, krb5-doc, 
	krb5-server, cyrus-sasl-gssapi
Note: client machines also need matching krb5-client



#### Kerberos Setup #######

In order to test the LWFS authentication service, 
we need to be able to register an LWFS service 
with the Kerberos Key Distribution Center (KDC). This
section details how to set up a KDC from scratch 
(assuming you have the MIT krb5-server software 
installed.  

@note There may be a way to use an existing kerberos realm
	(e.g., SRN.SANDIA.GOV), but I'm not sure how to do that. 


1) Create the LWFS.SANDIA.GOV realm:
	
	All steps performed as root. 

	a) Create a file /etc/krb5.conf with the following contents...

		------------ /etc/krb5.conf -----------

		[libdefaults]
			ticket_lifetime = 600
			default_realm = LWFS.SANDIA.GOV
			ccache_type = 2
			kdc_req_checksum_type = 2
			default_keytab_name = /etc/v5srvtab
			renew_lifetime = 14d
			forwardable = true
			preauth_list = 2
			default_tkt_enctypes = des-cbc-crc
			default_tgs_enctypes = des-cbc-crc des-cbc-md5 rc4-hmac
			default_etypes = des-cbc-crc des-cbc-md5
			dns_fallback = false

			[realms]
			LWFS.SANDIA.GOV = {
				kdc = capulin.sandia.gov:88
					admin_server = capulin.sandia.gov:464
					default_domain = sandia.gov
			}

		[domain_realm]
			.sandia.gov = LWFS.SANDIA.GOV

		------------ /etc/krb5.conf -----------
	
		Replace "capulin.sandia.gov" with your machine's host name. 

	b) As root, execute "kdb5_util create -s".  On Suse10, this looks like this...

		# /usr/lib/mit/sbin/kdb5_util create -s
		Loading random data
		Initializing database '/var/lib/kerberos/krb5kdc/principal' for realm 'LWFS.SANDIA.GOV',
		master key name 'K/M@LWFS.SANDIA.GOV'
		You will be prompted for the database Master Password.
		It is important that you NOT FORGET this password.
		Enter KDC database master key:
		Re-enter KDC database master key to verify:

		If an error occurs, you did not create the krb5.conf file correctly. 

	c) Look at what was created
		# ls -1a /var/lib/kerberos/krb5kdc
		./
		../
		.k5.LWFS.SANDIA.GOV
		kadm5.acl
		kdc.conf
		principal
		principal.kadm5
		principal.kadm5.lock
		principal.ok


2) Add raoldfi as an administrative user 

	# /usr/sbin/kadmin.local
	Authenticating as principal raoldfi/admin@LWFS.SANDIA.GOV with password.

	kadmin.local: listprincs
	K/M@LWFS.SANDIA.GOV
	kadmin/admin@LWFS.SANDIA.GOV
	kadmin/capulin.sandia.gov@LWFS.SANDIA.GOV
	kadmin/changepw@LWFS.SANDIA.GOV
	kadmin/history@LWFS.SANDIA.GOV
	krbtgt/LWFS.SANDIA.GOV@LWFS.SANDIA.GOV

	kadmin.local: addprinc raoldfi/admin
	WARNING: no policy specified for raoldfi/admin@LWFS.SANDIA.GOV; defaulting to no policy
	Enter password for principal "raoldfi/admin@LWFS.SANDIA.GOV":
	Re-enter password for principal "raoldfi/admin@LWFS.SANDIA.GOV":
	Principal "raoldfi/admin@LWFS.SANDIA.GOV" created.

	kadmin.local: exit

3) Add permissions to administer principals
	
	- Add this line to the file /var/lib/kerberos/krb5kdc/kadm5.acl
		raoldfi/admin@LWFS.SANDIA.GOV *


3.1) Add the service principal for the credential manager, 
	AND (!!!) for the host on which it runs.  
	Kerberos admin guide recommends using fully 
	qualified host names, so, make sure name resolution on that 
	machine returns fully qualified names. 

	kadmin.local 
	Authenticating as principal root/admin@LWFS.SANDIA.GOV with password.
	kadmin.local:  addprinc service_name/service_host.sandia.gov@LWFS.SANDIA.GOV
	WARNING: no policy specified for service_name/service_host.sandia.gov@LWFS.SANDIA.GOV; defaulting to no policy
	Enter password for principal "service_name/service_host.sandia.gov@LWFS.SANDIA.GOV": 
	Re-enter password for principal "service_name/service_host.sandia.gov@LWFS.SANDIA.GOV": 
	Principal "service_name/service_host.sandia.gov@LWFS.SANDIA.GOV" created.
	kadmin.local:  addprinc host/service_host.sandia.gov@LWFS.SANDIA.GOV
	... etc ...

4) Create the keytable file
	# kadmin.local: ktadd -k /var/lib/kerberos/krb5kdc/kadm5.keytab kadmin/admin kadmin/changepw service_name/service_host.sandia.gov host/service_host.sandia.gov
	Entry for principal kadmin/admin with kvno 3, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/var/lib/kerberos/krb5kdc/kadm5.keytab.
	Entry for principal kadmin/admin with kvno 3, encryption type DES cbc mode with CRC-32 added to keytab WRFILE:/var/lib/kerberos/krb5kdc/kadm5.keytab.
	Entry for principal kadmin/changepw with kvno 3, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/var/lib/kerberos/krb5kdc/kadm5.keytab.
	Entry for principal kadmin/changepw with kvno 3, encryption type DES cbc mode with CRC-32 added to keytab WRFILE:/var/lib/kerberos/krb5kdc/kadm5.keytab.
	... etc ...

5) Start the kerberos kdc daemon
	# /etc/init.d/krb5kdc start

6) Start the kerberos admin daemon
	# /etc/init.d/kadmind start

7) Log in as administrative user (no loger as root)

	% kinit raoldfi/admin
	Password for raoldfi/admin@LWFS.SANDIA.GOV:

	% klist
	Ticket cache: FILE:/tmp/krb5cc_14268
	Default principal: raoldfi/admin@LWFS.SANDIA.GOV

	Valid starting     Expires            Service principal
	03/03/06 13:38:44  03/03/06 13:48:44  krbtgt/LWFS.SANDIA.GOV@LWFS.SANDIA.GOV
	renew until 03/03/06 13:38:44


	Kerberos 4 ticket cache: /tmp/tkt14268
	klist: You have no tickets cached

8) 
  start the server
	(The server machine needs a keytab file containing it's service/host entry
	 as well as the krb5.conf identifying the kdc.)

	gss-server -verbose -logfile /tmp/serv.log service_name &

   start the client
	(The client machine also needs the krb5.conf file as above, 
	 directing it to the kdc server.)

	kinit -f 
	gss-client service_host service_name@service_host "mesg to send"

